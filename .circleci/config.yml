version: 2.1

jobs:
  build-amd-buildx:
    machine:
      image: ubuntu-2204:current
      docker_layer_caching: false
    resource_class: large
    steps:
      - checkout
      - run:
          name: Login to Docker Hub
          command: echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
      - run:
          name: Setup buildx
          command: |
            docker buildx create --use
            docker buildx inspect --bootstrap
      - run:
          name: Build with buildx (AMD)
          command: |
            echo "Starting AMD buildx build..."
            time docker buildx build \
              --cache-from type=registry,ref=docker.io/$DOCKER_USER/dlc-cache:amd \
              --cache-to type=registry,ref=docker.io/$DOCKER_USER/dlc-cache:amd,mode=max \
              -f Dockerfile.test \
              -t dlc-test:amd \
              --load \
              .

  build-arm-buildx:
    machine:
      image: ubuntu-2204:current
      docker_layer_caching: false
    resource_class: arm.large
    steps:
      - checkout
      - run:
          name: Login to Docker Hub
          command: echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
      - run:
          name: Setup buildx
          command: |
            docker buildx create --use
            docker buildx inspect --bootstrap
      - run:
          name: Build with buildx (ARM)
          command: |
            echo "Starting ARM buildx build..."
            time docker buildx build \
              --cache-from type=registry,ref=docker.io/$DOCKER_USER/dlc-cache:arm \
              --cache-to type=registry,ref=docker.io/$DOCKER_USER/dlc-cache:arm,mode=max \
              -f Dockerfile.test \
              -t dlc-test:arm \
              --load \
              .

workflows:
  buildx-test:
    jobs:
      - build-amd-buildx:
          context: docker-hub
      - build-arm-buildx:
          context: docker-hub
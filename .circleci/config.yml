version: 2.1

orbs:
  tbp: townerhale/tbp-orb-test@dev:alpha

jobs:
  # AMD build with buildx cache
  build-amd-buildx:
    machine:
      image: ubuntu-2204:current
      docker_layer_caching: true
    resource_class: large
    steps:
      - checkout
      - run:
          name: Setup buildx
          command: |
            docker buildx create --use
            docker buildx inspect --bootstrap
      - run:
          name: Build with buildx (AMD)
          command: |
            time docker buildx build \
              --cache-from type=registry,ref=cimg/base:current \
              -f Dockerfile.test \
              -t dlc-test:amd \
              --load \
              .

  # ARM build with buildx cache
  build-arm-buildx:
    machine:
      image: ubuntu-2204:current
      docker_layer_caching: true
    resource_class: arm.large
    steps:
      - checkout
      - run:
          name: Setup buildx
          command: |
            docker buildx create --use
            docker buildx inspect --bootstrap
      - run:
          name: Build with buildx (ARM)
          command: |
            time docker buildx build \
              --cache-from type=registry,ref=cimg/base:current \
              -f Dockerfile.test \
              -t dlc-test:arm \
              --load \
              .

workflows:
  dlc-comparison:
    jobs:
      - build-amd-buildx
      - build-arm-buildx